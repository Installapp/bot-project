# Spidey Bot – Discord Ticket, Moderation & Logging Bot

این ربات یک داشبورد سبک + سیستم تیکت + ابزارهای مدیریتی و یک مجموعه کامل لاگ را فراهم می‌کند. همه چیز با `discord.js v14` و `express` پیاده‌سازی شده و بدون دیتابیس خارجی کار می‌کند.

## فهرست مطالب
- نصب و راه‌اندازی
- تنظیمات مهم (توکن، چنل‌ها، وبهوک‌ها)
- ماندگاری با SQLite (اختیاری)
- دستورات و قابلیت‌ها
  - سیستم تیکت (دکمه و اسلش)
  - آنتی اسپم
  - خوش‌آمدگویی و DM
  - شمارنده اعضا و آنلاین‌ها
  - لاگ‌های کامل (عضو، پیام، چنل، نیک‌نیم، رول، ویس، بن/آن‌بن، تایم‌اوت، اینوایت، تنظیمات سرور)
  - داشبورد ساده وب
- تغییر چنل ارسال پیام‌ها (راهنمای ویرایش فایل‌ها)
- نکات دیپلوی و اجرا

---

## نصب و راه‌اندازی
1) Node.js 18+ نصب باشد.
2) مخزن را دانلود/کلون کنید و سپس:
```bash
npm install
```
3) فایل `.env` بسازید و توکن بات را قرار دهید:
```env
DISCORD_BOT_TOKEN=YOUR_BOT_TOKEN
PORT=3000
```
4) اجرا:
```bash
npm run start
# یا برای توسعه
npm run dev
```
بات پس از اجرا، داشبورد سبک را روی `http://localhost:3000` بالا می‌آورد (صفحه ورود ساده با رمز).

---

## تنظیمات مهم
- توکن: از `.env` خوانده می‌شود (`DISCORD_BOT_TOKEN`). اگر در `.env` نبود، از `config.js` برداشته می‌شود.
- چنل‌های لاگ: در فایل `bot.js` داخل ثابت `LOG_CHANNELS` تعریف شده‌اند:
```js
const LOG_CHANNELS = {
  member: '...',     // جوین/لفت/کیک
  message: '...',    // ادیت/حذف پیام
  channel: '...',    // ساخت/حذف/تغییر چنل
  nickname: '...',   // تغییر نیک‌نیم
  role: '...',       // ساخت/حذف/تغییر رول و تغییر رول‌های اعضا
  voice: '...',      // ورود/خروج/موو ویس
  ban: '...',        // بن/آن‌بن
  timeout: '...',    // تایم‌اوت اعمال/حذف
  invite: '...',     // ساخت/حذف اینوایت
  server: '...',     // تغییرات سرور (مثل اسم)
  fallback: '...'
};
```
- وبهوک کنسول: اگر بخواهید لاگ‌های کنسول به وبهوک ارسال شوند، متغیر `CONSOLE_WEBHOOK_URL` در `bot.js` را تنظیم و سوییچ `FORWARD_CONSOLE` را به `true` تغییر دهید. پیش‌فرض غیرفعال است و فقط در کنسول نمایش داده می‌شود.

---

## ماندگاری با SQLite (اختیاری)
برای این‌که تیکت‌ها و شمارنده بعد از ریستارت باقی بمانند، SQLite اضافه شده است.

### فعال‌سازی
1) پکیج‌ها را نصب کنید (اگر قبلاً نصب کرده‌اید، انجام شده است):
```bash
npm install
```
2) فایل‌های مربوطه:
- `db.js`: ساخت دیتابیس `data.sqlite` و جداول `tickets` و `meta`.
- `ticket.js`: شمارنده و اطلاعات تیکت را در دیتابیس ذخیره و بازیابی می‌کند.

هیچ کانفیگ اضافه‌ای نیاز نیست؛ فایل `data.sqlite` در روت پروژه ساخته می‌شود.

### چه چیزهایی ذخیره می‌شود؟
- جدول `tickets`: `channel_id`, `user_id`, `created_at`, `ticket_number`
- جدول `meta`: کلید `ticket_counter` برای آخرین شمارنده
- جدول `logs`: نسخه آرشیوشده تمام امبدهایی که ارسال می‌شوند (نوع، گیلد، چنل مقصد، عنوان، و payload کامل JSON)

برای پاکسازی، کافی است ربات را خاموش کنید و فایل `data.sqlite` را حذف نمایید.

---

## دستورات و قابلیت‌ها

### سیستم تیکت
- دستور `/ticket-panel` یک پنل با دکمه «ایجاد تیکت» می‌فرستد. با زدن دکمه، چنلی با نام `ticket-0001-username` ساخته می‌شود.
- بستن تیکت: دکمه «بستن تیکت». پس از بستن، دسترسی کاربر قطع می‌شود، چنل به کتگوری بسته‌ها منتقل می‌گردد و دکمه‌های «حذف» و «باز کردن» نمایش داده می‌شود. لاگ بستن/حذف طبق استایل تعریف‌شده ارسال می‌شود.
- باز کردن مجدد: ادمین می‌تواند باز کند؛ نام و دسترسی‌ها برمی‌گردد.
- حذف: قبل از حذف، ترنسکریپت HTML دیسکورد-استایل تولید و در چنل ترنسکریپت ارسال می‌شود.

محل کد: `ticket.js` (کلاس `TicketManager`)

### آنتی اسپم
در `bot.js` کلاس `AntiSpamManager` وجود دارد. محدودیت‌ها (تعداد پیام، تکرار، منشن، لینک، کپ‌لاک و ...) و مجازات‌ها (warn/timeout/kick) قابل تغییر است.

### خوش‌آمدگویی و DM
در رویداد `guildMemberAdd` پیام خوش‌آمد به چنل مشخص و یک DM به عضو جدید ارسال می‌شود. همچنین نقش اولیه و تغییر لقب نمونه اعمال می‌گردد (قابل حذف/ویرایش).

### شمارنده اعضا و آنلاین‌ها
توابع `updateMemberCountChannel` و `updateOnlineMemberCountChannel` نام چنل‌های شمارنده را با مقادیر جدید به‌روزرسانی می‌کنند و رخداد تغییر نام ویس نیز لاگ می‌شود.

### لاگ‌های کامل
در `bot.js` برای این موارد امبد ارسال می‌شود:
- عضو: جوین/لفت/کیک (Audit Log برای مجری)، نمایش کاربر به صورت «Tag (Mention)» و آواتار
- پیام: ادیت و حذف (قبل/بعد، چنل)
- چنل: ساخت/حذف/تغییر (نام، والد، دسترسی)
- نیک‌نیم: تغییر با دلیل (در صورت وجود در Audit Log)
- رول: ساخت/حذف/تغییرات رول و افزودن/حذف رول برای اعضا با نمایش «Added», «Removed», «Previous roles»
- ویس: ورود/خروج/موو با آمار `Users: count/limit`
- بن/آن‌بن: مطابق نمونه (User, ID) و در صورت نیاز Reason
- تایم‌اوت: اعمال/حذف به‌همراه مدت و زمان پایان
- اینوایت: ساخت/حذف به‌همراه Code، Channel، Expire نسبی و Max uses
- تنظیمات سرور: تغییر نام سرور

### داشبورد سبک وب
در `bot.js` با `express` یک داشبورد ساده ارائه می‌شود:
- صفحه ورود/فراموشی رمز (ارسال کد به وبهوک)
- صفحه اصلی با وضعیت بات، گیلدها، آمار روزانه، فرم‌های اقدام سریع (DM و ارسال پیام به چنل)

---

## تغییر چنل ارسال پیام‌ها
برای تغییر مقصد لاگ‌ها/پیام‌ها، شناسه‌ها را در کد ویرایش کنید:

### 1) چنل‌های لاگ در `bot.js`
```js
// bot.js
const LOG_CHANNELS = {
  member: '1413944186058833980',
  message: '1413949703124553848',
  channel: '1413949745935945914',
  nickname: '1413949204090454046',
  role: '1413949370776158380',
  voice: '1413949655099768932',
  ban: '1413949272407146716',
  timeout: '1413960573669871626',
  invite: '1413961019658604678',
  server: '1413949805562036284',
  fallback: '1415657800557793311'
};
```
هر کدام را با آیدی چنل دلخواه خود جایگزین کنید.

### 2) چنل ویژه ترنسکریپت تیکت در `ticket.js`
```js
// ticket.js
const TICKET_CONFIG = {
  openCategoryId: '...',
  closeCategoryId: '...',
  transcriptChannelId: '...' // این‌جا را تغییر دهید
};
```

### 3) چنل لاگ اکشن‌های تیکت
در `ticket.js` تابع `sendTicketActionLog` آیدی چنل لاگ را درون خودش دارد:
```js
const LOG_CHANNEL_ID = '1415289745231056986'; // تغییر دهید
```

### 4) شمارنده اعضا و آنلاین‌ها
در `bot.js` مقدار `MEMBER_COUNT_CHANNEL_ID` و `config.onlineMemberCountChannelId` را تنظیم کنید.

### 5) وبهوک کنسول (اختیاری)
در `bot.js` مقدار `CONSOLE_WEBHOOK_URL` را بگذارید و سوییچ `FORWARD_CONSOLE` را روی `true` بگذارید تا تمام `console.*` ها به وبهوک ارسال شود. برای غیر فعال بودن، `FORWARD_CONSOLE=false` است.

---

## نکات دیپلوی و اجرا
- حتماً intents لازم در Developer Portal فعال شوند (Guilds, Members, Messages, Message Content, Voice States, Presences, Invites).
- اجازه‌های لازم ربات در سرور را بررسی کنید (Manage Roles/Channels/Messages ...).
- برای هاست دائمی از PM2 یا سرویس‌های مشابه استفاده کنید.
- ریت‌لیمیت دیسکورد را رعایت کنید. لاگ‌ها به‌صورت کم‌حجم و ضروری ارسال می‌شوند.

---

## سوالات متداول
- خطای توکن: مقدار `DISCORD_BOT_TOKEN` را در `.env` بررسی کنید.
- لاگ‌ها نمی‌آیند: آیدی چنل‌ها و Permission ارسال پیام را چک کنید.
- ترنسکریپت خالی است: دسترسی خواندن تاریخچه پیام برای بات در چنل تیکت‌ها را بررسی کنید.

---

اگر می‌خواهید استایل امبدها/متن‌ها دقیقاً مثل نمونه‌های خودتان باشد، کافی است متن عنوان‌ها و فیلدها را در رویدادهای مربوطه در `bot.js` و `ticket.js` ویرایش کنید.
